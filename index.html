<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard Entregas</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background:#fafafa; }
    h2 { margin: 0 0 14px 0; }

    .row { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end; margin-top: 12px; }
    .box { background:#fff; border:1px solid #e3e3e3; border-radius:12px; padding:14px; }
    .filter { min-width: 280px; }

    label { font-size: 12px; color:#444; }
    select { width:100%; padding:8px 10px; border-radius:10px; border:1px solid #ddd; }

    .kpi { min-width: 240px; }
    .kpi .title { font-size:12px; color:#666; }
    .kpi .value { font-size:28px; font-weight:800; margin-top:6px; }
    .kpi .sub { font-size:12px; color:#666; margin-top:4px; white-space: nowrap; overflow:hidden; text-overflow: ellipsis; }

    .chartWrap { height: 440px; margin-top: 16px; }
    .hint { font-size:12px; color:#666; margin-top:8px; }

    .error {
      margin-top: 14px; padding: 10px 12px;
      background: #fff3f3; border: 1px solid #ffcccc;
      border-radius: 10px; color:#a40000;
    }
  </style>
</head>

<body>

<h2>Entregas por mes (AT / FT / No entregados)</h2>

<!-- Filtros -->
<div class="row">
  <div class="box filter">
    <label for="clienteSelect"><b>Cliente</b></label>
    <select id="clienteSelect">
      <option value="">Todos</option>
    </select>
    <div class="hint" id="clienteHint"></div>
  </div>

  <div class="box filter" style="min-width:220px;">
    <label for="mesSelect"><b>Mes</b></label>
    <select id="mesSelect"></select>
    <div class="hint" id="mesHint"></div>
  </div>
</div>

<div id="msg"></div>

<!-- KPIs generales -->
<div class="row">
  <div class="box kpi">
    <div class="title">Cantidad de pedidos</div>
    <div class="value" id="kpiTotal">-</div>
    <div class="sub">AT + FT + No entregados</div>
  </div>

  <div class="box kpi">
    <div class="title">% Entregados AT</div>
    <div class="value" id="kpiATpct">-</div>
    <div class="sub" id="kpiATqty">-</div>
  </div>

  <div class="box kpi">
    <div class="title">% Entregados FT</div>
    <div class="value" id="kpiFTpct">-</div>
    <div class="sub" id="kpiFTqty">-</div>
  </div>

  <div class="box kpi">
    <div class="title">% No entregados</div>
    <div class="value" id="kpiNOpct">-</div>
    <div class="sub" id="kpiNOqty">-</div>
  </div>
</div>

<!-- KPIs mensuales + variación -->
<div class="row">
  <div class="box kpi">
    <div class="title">% AT (mes)</div>
    <div class="value" id="kpiATmes">-</div>
    <div class="sub" id="kpiATmesSub">-</div>
  </div>

  <div class="box kpi">
    <div class="title">% FT (mes)</div>
    <div class="value" id="kpiFTmes">-</div>
    <div class="sub" id="kpiFTmesSub">-</div>
  </div>

  <div class="box kpi">
    <div class="title">% NO (mes)</div>
    <div class="value" id="kpiNOmes">-</div>
    <div class="sub" id="kpiNOmesSub">-</div>
  </div>

  <!-- KPI extra (recomendado): ENTREGADO TOTAL -->
  <div class="box kpi">
    <div class="title">% ENTREGADO TOTAL (AT+FT) (mes)</div>
    <div class="value" id="kpiTOTmes">-</div>
    <div class="sub" id="kpiTOTmesSub">-</div>
  </div>
</div>

<!-- Gráfico -->
<div class="box chartWrap">
  <div style="font-weight:700; margin-bottom:8px;">AT / FT / No entregados por mes (100% apilado)</div>
  <canvas id="chartMes"></canvas>
  <div class="hint">
    Etiqueta: <b>cantidad (xx.x%)</b>. Mes = <b>FECHA ENTREGA ESPERADA</b> (dd/mm/aaaa).
  </div>
</div>

<script>
/* ============================
   CONFIG
============================ */
const csvUrl = "CUMPLIMIENTO_2025.csv";   
const DELIM = ";";

const FECHA_COL = "FECHA ENTREGA ESPERADA";
const CLIENT_CANDIDATES = ["CLIENTE NRO.", "CLIENTE"];

const AT_COL = "ENTREGADOS AT";
const FT_COL = "ENTREGADOS FT";
const NO_COL = "NO ENTREGADOS";

/* ============================
   ESTADO
============================ */
let data = [];
let headers = [];
let CLIENT_COL = null;
let chartMes = null;

/* ============================
   HELPERS
============================ */
const clean = v => (v ?? "").toString().trim();

function toNumber(v) {
  let x = clean(v);
  if (!x) return 0;
  x = x.replace(/\s/g, "");
  if (x.includes(",")) x = x.replace(/\./g, "").replace(",", ".");
  const n = Number(x);
  return Number.isFinite(n) ? n : 0;
}

function parseDateDMY(s) {
  const p = clean(s).split("/");
  if (p.length !== 3) return null;
  const [d,m,y] = p.map(n => parseInt(n,10));
  if (!y || !m || !d) return null;
  return new Date(y, m-1, d);
}

function monthKey(d) {
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
}

function fmtInt(n) {
  return Number(n).toLocaleString("es-AR", { maximumFractionDigits: 0 });
}

function fmtPct01(x) {
  if (!isFinite(x)) return "-";
  return (x * 100).toFixed(1).replace(".", ",") + "%";
}

function fmtDelta01(d) {
  if (!isFinite(d)) return "Sin mes anterior";
  const arrow = d >= 0 ? "▲" : "▼";
  return `${arrow} ${(Math.abs(d)*100).toFixed(1).replace(".", ",")}% vs mes anterior`;
}

function showError(msg) {
  document.getElementById("msg").innerHTML = `<div class="error">${msg}</div>`;
}

/* ============================
   CSV PARSER
============================ */
function parseDelimited(text, delimiter=";") {
  const rows = [];
  let row = [], cur = "", inQuotes = false;

  text = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n");

  for (let i=0;i<text.length;i++) {
    const ch = text[i];
    if (ch === '"') {
      if (inQuotes && text[i+1] === '"') { cur += '"'; i++; }
      else inQuotes = !inQuotes;
    } else if (ch === delimiter && !inQuotes) {
      row.push(cur); cur = "";
    } else if (ch === "\n" && !inQuotes) {
      row.push(cur); rows.push(row);
      row = []; cur = "";
    } else cur += ch;
  }
  if (cur || row.length) { row.push(cur); rows.push(row); }
  return rows;
}

/* ============================
   FILTROS
============================ */
function filteredRowsByCliente() {
  const c = document.getElementById("clienteSelect").value;
  return c ? data.filter(r => clean(r[CLIENT_COL]) === c) : data;
}

function getMonthKeyFromRow(r) {
  const d = parseDateDMY(r[FECHA_COL]);
  return d ? monthKey(d) : null;
}

function buildMesSelect(rows) {
  const sel = document.getElementById("mesSelect");
  const months = [...new Set(rows.map(getMonthKeyFromRow).filter(Boolean))].sort();

  const prevSelected = sel.value;
  sel.innerHTML = "";

  months.forEach(m => {
    const o = document.createElement("option");
    o.value = m;
    o.textContent = m;
    sel.appendChild(o);
  });

  // Mantener selección si existe; si no, usar último
  if (months.includes(prevSelected)) sel.value = prevSelected;
  else sel.value = months[months.length - 1] || "";

  document.getElementById("mesHint").textContent = sel.value ? `Mes seleccionado: ${sel.value}` : "Sin meses";
  return months;
}

/* ============================
   KPIs
============================ */
function calcTotals(rows) {
  let at = 0, ft = 0, no = 0;
  for (const r of rows) {
    at += toNumber(r[AT_COL]);
    ft += toNumber(r[FT_COL]);
    no += toNumber(r[NO_COL]);
  }
  const total = at + ft + no;
  return { at, ft, no, total };
}

function updateKPIsGeneral(rows) {
  const t = calcTotals(rows);
  const pctAT = t.total ? t.at / t.total : NaN;
  const pctFT = t.total ? t.ft / t.total : NaN;
  const pctNO = t.total ? t.no / t.total : NaN;

  document.getElementById("kpiTotal").textContent = fmtInt(t.total);

  document.getElementById("kpiATpct").textContent = fmtPct01(pctAT);
  document.getElementById("kpiATqty").textContent = `Cantidad: ${fmtInt(t.at)}`;

  document.getElementById("kpiFTpct").textContent = fmtPct01(pctFT);
  document.getElementById("kpiFTqty").textContent = `Cantidad: ${fmtInt(t.ft)}`;

  document.getElementById("kpiNOpct").textContent = fmtPct01(pctNO);
  document.getElementById("kpiNOqty").textContent = `Cantidad: ${fmtInt(t.no)}`;
}

function calcMonthTotals(rows, month) {
  let at = 0, ft = 0, no = 0;

  for (const r of rows) {
    if (getMonthKeyFromRow(r) !== month) continue;
    at += toNumber(r[AT_COL]);
    ft += toNumber(r[FT_COL]);
    no += toNumber(r[NO_COL]);
  }

  const total = at + ft + no;

  const pctAT = total ? at / total : NaN;
  const pctFT = total ? ft / total : NaN;
  const pctNO = total ? no / total : NaN;
  const pctTOT = total ? (at + ft) / total : NaN;

  return { at, ft, no, total, pctAT, pctFT, pctNO, pctTOT };
}

function updateKPIsMonthly(rows, months) {
  const mes = document.getElementById("mesSelect").value;
  if (!mes) return;

  const idx = months.indexOf(mes);
  const prevMes = idx > 0 ? months[idx - 1] : null;

  const cur = calcMonthTotals(rows, mes);
  const prev = prevMes ? calcMonthTotals(rows, prevMes) : null;

  // AT
  document.getElementById("kpiATmes").textContent = fmtPct01(cur.pctAT);
  document.getElementById("kpiATmesSub").textContent =
    `Cant: ${fmtInt(cur.at)} · ${prev ? fmtDelta01(cur.pctAT - prev.pctAT) : "Sin mes anterior"}`;

  // FT
  document.getElementById("kpiFTmes").textContent = fmtPct01(cur.pctFT);
  document.getElementById("kpiFTmesSub").textContent =
    `Cant: ${fmtInt(cur.ft)} · ${prev ? fmtDelta01(cur.pctFT - prev.pctFT) : "Sin mes anterior"}`;

  // NO
  document.getElementById("kpiNOmes").textContent = fmtPct01(cur.pctNO);
  document.getElementById("kpiNOmesSub").textContent =
    `Cant: ${fmtInt(cur.no)} · ${prev ? fmtDelta01(cur.pctNO - prev.pctNO) : "Sin mes anterior"}`;

  // TOTAL ENTREGADO (AT+FT) (extra)
  document.getElementById("kpiTOTmes").textContent = fmtPct01(cur.pctTOT);
  document.getElementById("kpiTOTmesSub").textContent =
    `Cant: ${fmtInt(cur.at + cur.ft)} · ${prev ? fmtDelta01(cur.pctTOT - prev.pctTOT) : "Sin mes anterior"}`;

  document.getElementById("mesHint").textContent = `Mes seleccionado: ${mes}` + (prevMes ? ` · Anterior: ${prevMes}` : "");
}

/* ============================
   GRÁFICO 100% APILADO con etiquetas cantidad + %
============================ */
function buildChartMes(rows) {
  const agg = new Map();
  const monthsSet = new Set();

  for (const r of rows) {
    const d = parseDateDMY(r[FECHA_COL]);
    if (!d) continue;

    const mk = monthKey(d);
    monthsSet.add(mk);

    if (!agg.has(mk)) agg.set(mk, { at: 0, ft: 0, no: 0 });
    const c = agg.get(mk);

    c.at += toNumber(r[AT_COL]);
    c.ft += toNumber(r[FT_COL]);
    c.no += toNumber(r[NO_COL]);
  }

  const months = [...monthsSet].sort();
  const qAT = months.map(m => agg.get(m)?.at ?? 0);
  const qFT = months.map(m => agg.get(m)?.ft ?? 0);
  const qNO = months.map(m => agg.get(m)?.no ?? 0);

  const pAT = qAT.map((v,i)=>{const t=qAT[i]+qFT[i]+qNO[i]; return t? v/t*100:0});
  const pFT = qFT.map((v,i)=>{const t=qAT[i]+qFT[i]+qNO[i]; return t? v/t*100:0});
  const pNO = qNO.map((v,i)=>{const t=qAT[i]+qFT[i]+qNO[i]; return t? v/t*100:0});

  const ctx = document.getElementById("chartMes").getContext("2d");
  if (chartMes) chartMes.destroy();

  chartMes = new Chart(ctx, {
    type: "bar",
    data: {
      labels: months,
      datasets: [
        { label: "Entregados AT", data: pAT, _q: qAT, stack: "s" },
        { label: "Entregados FT", data: pFT, _q: qFT, stack: "s" },
        { label: "No entregados", data: pNO, _q: qNO, stack: "s" }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: { stacked: true },
        y: { stacked: true, beginAtZero: true, max: 100, ticks: { callback: v => v + "%" } }
      },
      plugins: {
        legend: { position: "bottom" },
        tooltip: {
          mode: "index",
          intersect: false,
          callbacks: {
            label: (c) => {
              const pct = (c.parsed.y ?? 0).toFixed(1).replace(".", ",");
              const qty = c.dataset._q?.[c.dataIndex] ?? 0;
              return `${c.dataset.label}: ${fmtInt(qty)} (${pct}%)`;
            }
          }
        },
        datalabels: {
          formatter: (v, ctx) => {
            const qty = ctx.dataset._q?.[ctx.dataIndex] ?? 0;
            if (!qty || v < 4) return ""; // ocultar si es muy chico
            return `${fmtInt(qty)} (${v.toFixed(1).replace(".", ",")}%)`;
          },
          anchor: "center",
          align: "center",
          clamp: true
        }
      }
    },
    plugins: [ChartDataLabels]
  });
}

/* ============================
   UI
============================ */
function renderClientes() {
  const sel = document.getElementById("clienteSelect");
  const clientes = [...new Set(data.map(r => clean(r[CLIENT_COL])).filter(Boolean))]
    .sort((a,b)=>a.localeCompare(b,'es'));

  sel.querySelectorAll("option:not([value=''])").forEach(o=>o.remove());

  clientes.forEach(c=>{
    const o=document.createElement("option");
    o.value=c; o.textContent=c;
    sel.appendChild(o);
  });
}

function applyAll() {
  const rows = filteredRowsByCliente();

  // Rebuild meses según el cliente filtrado
  const months = buildMesSelect(rows);

  // KPIs
  updateKPIsGeneral(rows);
  updateKPIsMonthly(rows, months);

  // Gráfico
  buildChartMes(rows);
}

/* ============================
   LOAD
============================ */
fetch(csvUrl)
  .then(r => r.text())
  .then(text => {
    const m = parseDelimited(text, DELIM);
    if (!m.length || m.length < 2) return showError("El CSV está vacío o no tiene filas.");

    headers = m[0].map(clean);

    CLIENT_COL = CLIENT_CANDIDATES.find(c => headers.includes(c));
    if (!CLIENT_COL) return showError("No encuentro columna CLIENTE (probé: " + CLIENT_CANDIDATES.join(" / ") + ")");

    const required = [FECHA_COL, AT_COL, FT_COL, NO_COL];
    const missing = required.filter(c => !headers.includes(c));
    if (missing.length) return showError("Faltan columnas: " + missing.join(", "));

    data = m.slice(1).map(r => {
      const o = {};
      headers.forEach((h,i)=> o[h] = clean(r[i]));
      return o;
    });

    document.getElementById("clienteHint").textContent = `Columna cliente: ${CLIENT_COL}`;

    renderClientes();
    applyAll();

    document.getElementById("clienteSelect").addEventListener("change", () => {
      applyAll(); // al cambiar cliente: cambia meses disponibles + KPIs + gráfico
    });

    document.getElementById("mesSelect").addEventListener("change", () => {
      const rows = filteredRowsByCliente();
      const months = [...new Set(rows.map(getMonthKeyFromRow).filter(Boolean))].sort();
      updateKPIsMonthly(rows, months); // al cambiar mes: solo cambian KPIs mensuales + hint
    });
  })
  .catch(err => {
    showError("Error cargando CSV. Revisá el nombre del archivo en csvUrl y que esté en el repo.");
    console.error(err);
  });
</script>

</body>
</html>


<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dashboard Cumplimiento</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background:#fafafa; }
    h2 { margin: 0 0 14px 0; }

    .row { display:flex; gap:16px; flex-wrap:wrap; align-items:flex-end; }
    .box { background:#fff; border:1px solid #e3e3e3; border-radius:12px; padding:14px; }
    .filter { min-width: 320px; }
    label { font-size: 12px; color:#444; }
    select { width:100%; padding:8px 10px; border-radius:10px; border:1px solid #ddd; }

    .kpis { display:flex; gap:12px; flex-wrap:wrap; }
    .kpi { min-width: 210px; }
    .kpi .title { font-size:12px; color:#666; }
    .kpi .value { font-size:28px; font-weight:800; margin-top:6px; }
    .kpi .sub { font-size:12px; color:#666; margin-top:4px; }

    .grid { display:grid; grid-template-columns: 1.2fr 1fr; gap:16px; margin-top:16px; }
    @media (max-width: 980px) { .grid { grid-template-columns: 1fr; } }

    .chartWrap { height: 360px; }
    .tableWrap { max-height: 55vh; overflow:auto; }
    table { border-collapse: collapse; width:100%; background:#fff; }
    th, td { border: 1px solid #ddd; padding: 6px 8px; font-size: 12px; text-align:left; }
    th { background:#f2f2f2; position: sticky; top: 0; z-index: 1; }

    .hint { font-size:12px; color:#666; margin-top:8px; }
    .error { margin-top: 14px; padding: 10px 12px; background: #fff3f3; border: 1px solid #ffcccc; border-radius: 10px; color:#a40000; }
  </style>
</head>

<body>
  <h2>Cumplimiento de pedidos</h2>

  <div class="row">
    <div class="box filter">
      <label for="clienteSelect"><b>Cliente</b></label>
      <select id="clienteSelect">
        <option value="">Todos</option>
      </select>
      <div class="hint" id="clienteHint"></div>
    </div>

    <div class="kpis">
      <div class="box kpi">
        <div class="title">Pedidos totales</div>
        <div class="value" id="kpiTotal">-</div>
        <div class="sub" id="kpiTotalSub"></div>
      </div>

      <div class="box kpi">
        <div class="title">Pedidos cumplidos</div>
        <div class="value" id="kpiCumplidos">-</div>
        <div class="sub" id="kpiCumplidosSub"></div>
      </div>

      <div class="box kpi">
        <div class="title">Pendientes</div>
        <div class="value" id="kpiPendientes">-</div>
        <div class="sub">Totales - Cumplidos</div>
      </div>

      <div class="box kpi">
        <div class="title">% Cumplimiento</div>
        <div class="value" id="kpiPct">-</div>
        <div class="sub">Cumplidos / Totales</div>
      </div>
    </div>
  </div>

  <div id="msg"></div>

  <div class="grid">
    <div class="box">
      <div style="font-weight:700; margin-bottom:8px;">Cumplimiento por mes</div>
      <div class="chartWrap"><canvas id="chartMes"></canvas></div>
      <div class="hint">Usa <b>FECHA ENTREGA ESPERADA</b> (dd/mm/aaaa). Si elegís un cliente, se grafica ese cliente. Si no, Top 5 clientes por volumen.</div>
    </div>

    <div class="box">
      <div style="font-weight:700; margin-bottom:8px;">Distribución de estados (filtrado)</div>
      <div class="chartWrap"><canvas id="chartEstados"></canvas></div>
      <div class="hint">Cuenta filas con <b>NRO. VA01/VA21</b> no vacío, agrupadas por estado.</div>
    </div>
  </div>

  <div class="box" style="margin-top:16px;">
    <div style="font-weight:700; margin-bottom:8px;">Detalle (primeras filas)</div>
    <div class="tableWrap">
      <table id="tabla"></table>
    </div>
    <div class="hint">Se muestran 30 filas.</div>
  </div>

<script>
  // ============================
  // CONFIG
  // ============================
  const csvUrl = "CUMPLIMIENTO_2025.csv";   // <-- Cambiá si tu archivo se llama distinto
  const DELIM  = ";";

  // Columnas fijas
  const NRO_COL   = "NRO. VA01/VA21";
  const FECHA_COL = "FECHA ENTREGA ESPERADA";

  // Columnas con fallback automático
  const CLIENT_CANDIDATES = ["CLIENTE NRO.", "CLIENTE"];
  const ESTADO_CANDIDATES = ["ESTADO ITEM", "ESTADOS"];

  const CUMPLIDO_VALUE = "CUMPLIDO";
  const MAX_ROWS_TABLE = 30;

  // ============================
  // ESTADO
  // ============================
  let data = [];
  let headers = [];

  let CLIENT_COL = null;
  let ESTADO_COL = null;

  let chartMes = null;
  let chartEstados = null;

  // ============================
  // CSV parser robusto (comillas)
  // ============================
  function parseDelimited(text, delimiter = ";") {
    const rows = [];
    let row = [];
    let cur = "";
    let inQuotes = false;

    text = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n");

    for (let i = 0; i < text.length; i++) {
      const ch = text[i];

      if (ch === '"') {
        if (inQuotes && text[i + 1] === '"') { cur += '"'; i++; }
        else { inQuotes = !inQuotes; }
      } else if (ch === delimiter && !inQuotes) {
        row.push(cur); cur = "";
      } else if (ch === "\n" && !inQuotes) {
        row.push(cur); rows.push(row);
        row = []; cur = "";
      } else {
        cur += ch;
      }
    }
    if (cur.length > 0 || row.length > 0) { row.push(cur); rows.push(row); }
    return rows;
  }

  const clean = v => (v ?? "").toString().trim();

  function parseDateDMY(s) {
    // dd/mm/aaaa
    const v = clean(s);
    if (!v) return null;
    const parts = v.split("/");
    if (parts.length !== 3) return null;

    const dd = parseInt(parts[0], 10);
    const mm = parseInt(parts[1], 10);
    const yyyy = parseInt(parts[2], 10);

    if (!yyyy || !mm || !dd) return null;
    return new Date(yyyy, mm - 1, dd);
  }

  function monthKey(d) {
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2, "0");
    return `${y}-${m}`; // YYYY-MM
  }

  function showError(msg) {
    document.getElementById("msg").innerHTML = `<div class="error">${msg}</div>`;
  }

  function setText(id, value) {
    document.getElementById(id).textContent = value;
  }

  function fmtInt(n) {
    return Number(n).toLocaleString("es-AR");
  }

  function fmtPct(x) {
    if (!isFinite(x)) return "-";
    return (x * 100).toFixed(1).replace(".", ",") + "%";
  }

  // ============================
  // Reglas KPI
  // ============================
  function rowsWithPedido(rows) {
    return rows.filter(r => clean(r[NRO_COL]) !== "");
  }

  function calcKPIs(rows) {
    const base = rowsWithPedido(rows);
    const total = base.length;

    const cumplidos = base.filter(r => clean(r[ESTADO_COL]).toUpperCase() === CUMPLIDO_VALUE).length;
    const pendientes = Math.max(total - cumplidos, 0);
    const pct = total > 0 ? (cumplidos / total) : NaN;

    return { total, cumplidos, pendientes, pct, base };
  }

  // ============================
  // UI: Select de clientes
  // ============================
  function renderClientesSelect() {
    const sel = document.getElementById("clienteSelect");

    const clientes = [...new Set(
      data.map(r => clean(r[CLIENT_COL])).filter(Boolean)
    )].sort((a,b) => a.localeCompare(b, 'es'));

    sel.querySelectorAll("option:not([value=''])").forEach(o => o.remove());

    clientes.forEach(c => {
      const opt = document.createElement("option");
      opt.value = c;
      opt.textContent = c;
      sel.appendChild(opt);
    });
  }

  // ============================
  // Gráfico 1: Cumplimiento por mes
  // ============================
  function buildChartMes(rows) {
    const base = rowsWithPedido(rows);

    // cliente -> mes -> {total, cumplidos}
    const agg = new Map();
    const allMonths = new Set();

    for (const r of base) {
      const cliente = clean(r[CLIENT_COL]) || "(Sin cliente)";
      const estado  = clean(r[ESTADO_COL]).toUpperCase();

      const d = parseDateDMY(r[FECHA_COL]);
      if (!d) continue;

      const mk = monthKey(d);
      allMonths.add(mk);

      if (!agg.has(cliente)) agg.set(cliente, new Map());
      const byMonth = agg.get(cliente);

      if (!byMonth.has(mk)) byMonth.set(mk, { total: 0, cumplidos: 0 });
      const cell = byMonth.get(mk);

      cell.total += 1;
      if (estado === CUMPLIDO_VALUE) cell.cumplidos += 1;
    }

    const months = [...allMonths].sort();

    const selected = document.getElementById("clienteSelect").value;
    let clientesToPlot = [];

    if (selected) {
      clientesToPlot = [selected];
    } else {
      // top 5 por volumen total
      const totals = [...agg.entries()].map(([c, m]) => {
        let t = 0;
        for (const v of m.values()) t += v.total;
        return { cliente: c, total: t };
      }).sort((a,b) => b.total - a.total).slice(0, 5);

      clientesToPlot = totals.map(x => x.cliente);
    }

    const datasets = clientesToPlot.map(cliente => {
      const byMonth = agg.get(cliente) || new Map();
      const serie = months.map(mk => {
        const v = byMonth.get(mk);
        if (!v || v.total === 0) return null;
        return Math.round((v.cumplidos / v.total) * 1000) / 10; // % con 1 decimal
      });

      return {
        label: cliente,
        data: serie,
        spanGaps: false,
        tension: 0.25
      };
    });

    const ctx = document.getElementById("chartMes").getContext("2d");
    if (chartMes) chartMes.destroy();

    chartMes = new Chart(ctx, {
      type: "line",
      data: { labels: months, datasets },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true, max: 100, ticks: { callback: v => v + "%" } }
        },
        plugins: {
          legend: { position: "bottom" },
          tooltip: { callbacks: { label: (c) => `${c.dataset.label}: ${c.parsed.y}%` } }
        }
      }
    });
  }

  // ============================
  // Gráfico 2: Distribución de estados
  // ============================
  function buildChartEstados(rows) {
    const base = rowsWithPedido(rows);
    const map = new Map();

    for (const r of base) {
      const e = clean(r[ESTADO_COL]) || "(Vacío)";
      map.set(e, (map.get(e) || 0) + 1);
    }

    const arr = [...map.entries()].sort((a,b) => b[1] - a[1]);
    const labels = arr.map(x => x[0]);
    const values = arr.map(x => x[1]);

    const ctx = document.getElementById("chartEstados").getContext("2d");
    if (chartEstados) chartEstados.destroy();

    chartEstados = new Chart(ctx, {
      type: "doughnut",
      data: { labels, datasets: [{ data: values }] },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: "bottom" } }
      }
    });
  }

  // ============================
  // Tabla
  // ============================
  function renderTable(rows) {
    const table = document.getElementById("tabla");
    table.innerHTML = "";

    const thead = document.createElement("thead");
    const trh = document.createElement("tr");

    const preferred = [CLIENT_COL, NRO_COL, ESTADO_COL, FECHA_COL, "PRIORIDAD", "CLASE DE DOC", "REF.CLIENTE", "DOC. REF"];
    const cols = [
      ...preferred.filter(c => headers.includes(c)),
      ...headers.filter(h => !preferred.includes(h)).slice(0, 10)
    ];

    cols.forEach(h => {
      const th = document.createElement("th");
      th.textContent = h;
      trh.appendChild(th);
    });
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = document.createElement("tbody");
    rows.slice(0, MAX_ROWS_TABLE).forEach(r => {
      const tr = document.createElement("tr");
      cols.forEach(h => {
        const td = document.createElement("td");
        td.textContent = r[h] ?? "";
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
  }

  // ============================
  // Refrescar todo con filtro
  // ============================
  function applyFilter() {
    const selCliente = document.getElementById("clienteSelect").value;

    const filtered = selCliente
      ? data.filter(r => clean(r[CLIENT_COL]) === selCliente)
      : data;

    const k = calcKPIs(filtered);

    setText("kpiTotal", fmtInt(k.total));
    setText("kpiCumplidos", fmtInt(k.cumplidos));
    setText("kpiPendientes", fmtInt(k.pendientes));
    setText("kpiPct", fmtPct(k.pct));

    buildChartMes(filtered);
    buildChartEstados(filtered);
    renderTable(filtered);
  }

  // ============================
  // Carga inicial
  // ============================
  fetch(csvUrl)
    .then(r => r.text())
    .then(text => {
      const matrix = parseDelimited(text, DELIM);
      if (!matrix.length || matrix.length < 2) {
        showError("El CSV parece vacío o no tiene filas suficientes.");
        return;
      }

      headers = matrix[0].map(clean);
      const body = matrix.slice(1);

      // detectar columnas cliente/estado
      CLIENT_COL = CLIENT_CANDIDATES.find(c => headers.includes(c)) || null;
      ESTADO_COL = ESTADO_CANDIDATES.find(c => headers.includes(c)) || null;

      // Validaciones mínimas
      const missing = [];
      if (!headers.includes(NRO_COL)) missing.push(NRO_COL);
      if (!headers.includes(FECHA_COL)) missing.push(FECHA_COL);
      if (!CLIENT_COL) missing.push("CLIENTE (se probó: " + CLIENT_CANDIDATES.join(" / ") + ")");
      if (!ESTADO_COL) missing.push("ESTADO (se probó: " + ESTADO_CANDIDATES.join(" / ") + ")");

      if (missing.length) {
        showError("No encuentro estas columnas en el CSV: <b>" + missing.join(", ") + "</b>.<br><br>" +
                  "Revisá el encabezado del CSV o avisame los nombres exactos.");
        return;
      }

      // armar objetos
      data = body.map(cols => {
        const obj = {};
        headers.forEach((h, i) => obj[h] = clean(cols[i]));
        return obj;
      });

      // textos UI
      document.getElementById("clienteHint").textContent = `Filtro usando columna: ${CLIENT_COL}`;
      document.getElementById("kpiTotalSub").innerHTML = `Filas con <b>${NRO_COL}</b> no vacío`;
      document.getElementById("kpiCumplidosSub").innerHTML = `<b>${ESTADO_COL}</b> = CUMPLIDO`;

      renderClientesSelect();
      applyFilter();
      document.getElementById("clienteSelect").addEventListener("change", applyFilter);
    })
    .catch(err => {
      showError("Error cargando el CSV. Revisá el nombre del archivo (csvUrl) y que esté en el repo.");
      console.error(err);
    });
</script>

</body>
</html>

